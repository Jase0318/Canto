<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CantoLearn AI (修復版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #f8fafc; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #0d9488; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800 flex flex-col min-h-screen">

    <!-- Header -->
    <div class="bg-white border-b p-4 sticky top-0 z-10 flex justify-between items-center shadow-sm">
        <h1 class="font-bold text-xl text-teal-700 flex items-center gap-2">
            <span class="bg-teal-600 text-white px-2 rounded">粵</span> CantoLearn
        </h1>
        <button onclick="resetKey()" class="text-xs text-slate-400 underline hover:text-red-500">重設 Key</button>
    </div>

    <!-- Main -->
    <div class="flex-1 max-w-2xl mx-auto w-full p-4 space-y-6">
        
        <!-- Input Area -->
        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
            <textarea id="input" class="w-full h-32 outline-none resize-none text-lg placeholder:text-slate-300" placeholder="請輸入中文..."></textarea>
            <div class="flex justify-end pt-2">
                <button id="btn-translate" onclick="translateText()" class="bg-teal-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-teal-700 transition flex items-center gap-2">
                    翻譯
                </button>
            </div>
        </div>

        <!-- Results -->
        <div id="result-area" class="hidden">
            <h3 class="font-bold text-slate-500 text-sm mb-3 border-b pb-1">翻譯結果</h3>
            <div id="cards" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
        </div>

        <!-- History -->
        <div class="pt-8">
            <h3 class="font-bold text-slate-500 text-sm mb-3 border-b pb-1">歷史紀錄</h3>
            <div id="history-list" class="space-y-3 text-sm text-slate-400 text-center">暫無紀錄</div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="key-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl w-full max-w-sm shadow-2xl">
            <h3 class="font-bold text-lg mb-4">設定 API Key</h3>
            <input type="password" id="key-input" class="w-full border p-3 rounded mb-4" placeholder="貼上 AIza 開頭的 Key">
            <button onclick="saveKey()" class="w-full bg-teal-600 text-white py-3 rounded font-bold">確定</button>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="block text-center text-xs text-teal-600 mt-4 underline">取得免費 Key</a>
        </div>
    </div>

    <script>
        // 1. 初始化
        let apiKey = localStorage.getItem('cantolearn_key');
        let history = JSON.parse(localStorage.getItem('cantolearn_history') || '[]');
        
        if (!apiKey) document.getElementById('key-modal').classList.remove('hidden');
        else document.getElementById('key-modal').classList.add('flex');
        
        renderHistory();

        // 2. 核心功能
        function saveKey() {
            const k = document.getElementById('key-input').value.trim();
            if(!k) return alert('請輸入 Key');
            apiKey = k;
            localStorage.setItem('cantolearn_key', k);
            document.getElementById('key-modal').classList.add('hidden');
        }

        function resetKey() {
            if(confirm('確定要重設 API Key 嗎？')) {
                localStorage.removeItem('cantolearn_key');
                location.reload();
            }
        }

        async function translateText() {
            const text = document.getElementById('input').value.trim();
            if (!text) return;
            
            const btn = document.getElementById('btn-translate');
            btn.innerHTML = '<div class="loader"></div>';
            btn.disabled = true;

            try {
                // 使用最穩定的 Fetch 原生寫法，不依賴任何 SDK
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are a Cantonese translator. Translate "${text}" to Traditional Chinese and LSHK Jyutping.
                                Output JSON Array ONLY: [{"text": "詞", "jyutping": "ping1", "pos": "n"}]`
                            }]
                        }]
                    })
                });

                const data = await response.json();
                
                // 錯誤處理
                if (data.error) {
                    throw new Error(data.error.message);
                }

                // 解析結果
                let rawText = data.candidates[0].content.parts[0].text;
                // 清理可能包含的 markdown 符號
                rawText = rawText.replace(/```json|```/g, '').trim();
                const items = JSON.parse(rawText);
                
                renderResults(items);
                saveHistory(text, items);

            } catch (e) {
                alert(`錯誤：${e.message}\n\n請檢查 Key 是否正確，或是否選對了 Project。`);
                if (e.message.includes('API key not valid')) {
                    resetKey();
                }
            } finally {
                btn.innerHTML = '翻譯';
                btn.disabled = false;
            }
        }

        // 3. 渲染畫面
        function renderResults(items) {
            const container = document.getElementById('cards');
            document.getElementById('result-area').classList.remove('hidden');
            container.innerHTML = items.map(item => `
                <div class="bg-white p-4 rounded-xl border shadow-sm text-center relative group hover:border-teal-400 transition">
                    <div class="text-xs text-slate-400 uppercase font-bold mb-1">${item.pos || 'WORD'}</div>
                    <div class="text-2xl font-bold text-slate-800 mb-1">${item.text}</div>
                    <div class="text-teal-600 bg-teal-50 px-2 py-1 rounded text-sm font-mono inline-block">${item.jyutping}</div>
                    <button onclick="speak('${item.text}')" class="absolute top-2 right-2 text-slate-300 hover:text-teal-600">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5 6 9 2 9 2 15 6 15 11 19 11 5M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                    </button>
                </div>
            `).join('');
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            if (history.length === 0) return;
            
            list.innerHTML = history.map(h => `
                <div class="bg-white p-4 rounded-xl border shadow-sm">
                    <div class="flex justify-between text-xs text-slate-400 mb-2">
                        <span>${new Date(h.date).toLocaleString()}</span>
                    </div>
                    <div class="font-bold text-lg mb-2">${h.text}</div>
                    <div class="flex flex-wrap gap-2">
                        ${h.result.map(r => `<span class="text-xs bg-slate-50 border px-1 rounded text-slate-600">${r.text} <span class="text-teal-600">${r.jyutping}</span></span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function saveHistory(text, result) {
            history.unshift({ text, result, date: new Date() });
            if (history.length > 20) history.pop();
            localStorage.setItem('cantolearn_history', JSON.stringify(history));
            renderHistory();
        }

        function speak(text) {
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-HK';
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
