<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CantoLearn AI - 粵語學習助手 (修復版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 1. 使用 cdnjs (更穩定) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        /* 錯誤訊息樣式 */
        #error-log { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #fee2e2; color: #991b1b; padding: 1rem; font-size: 12px; font-family: monospace; z-index: 9999; max-height: 200px; overflow: auto; border-top: 2px solid #ef4444; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <!-- 載入狀態與錯誤顯示 (純 HTML/JS，不依賴 React) -->
    <div id="loading-screen" class="fixed inset-0 flex items-center justify-center flex-col gap-4 bg-slate-50 z-50 transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-teal-100 border-t-teal-600 rounded-full animate-spin"></div>
        <div class="text-center space-y-2">
            <div class="font-bold text-slate-700 text-lg">系統啟動中...</div>
            <div id="status-text" class="text-xs text-slate-400 font-mono">Initializing...</div>
        </div>
        <!-- 重試按鈕 (預設隱藏) -->
        <button id="retry-btn" onclick="window.location.reload()" class="hidden px-4 py-2 bg-teal-600 text-white rounded shadow hover:bg-teal-700 text-sm">
            重新整理頁面
        </button>
    </div>

    <!-- 錯誤日誌區 -->
    <div id="error-log"></div>

    <!-- React 掛載點 -->
    <div id="root"></div>

    <!-- 2. 系統自我檢查腳本 (立即執行) -->
    <script>
        const statusEl = document.getElementById('status-text');
        const errorLog = document.getElementById('error-log');
        const retryBtn = document.getElementById('retry-btn');

        // 顯示錯誤函式
        function logError(msg) {
            document.getElementById('loading-screen').style.background = '#fff1f2'; // 變紅
            statusEl.style.color = '#e11d48';
            statusEl.innerHTML = '⚠️ 發生錯誤 (請截圖)';
            retryBtn.classList.remove('hidden');
            
            errorLog.style.display = 'block';
            const line = document.createElement('div');
            line.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            errorLog.appendChild(line);
            console.error(msg);
        }

        // 全域錯誤攔截
        window.onerror = function(msg, url, line) {
            logError(`${msg} (Line: ${line})`);
            return false;
        };

        // 檢查資源載入
        window.onload = function() {
            statusEl.innerText = "Checking libraries...";
            const missing = [];
            if (!window.React) missing.push("React");
            if (!window.ReactDOM) missing.push("ReactDOM");
            if (!window.Babel) missing.push("Babel");

            if (missing.length > 0) {
                logError(`核心資源載入失敗: ${missing.join(', ')}。請檢查網路連線。`);
            } else {
                statusEl.innerText = "Libraries loaded. Starting App...";
                // 設置 5 秒超時，如果 React 還沒接手就報錯
                setTimeout(() => {
                    const loader = document.getElementById('loading-screen');
                    if (loader && loader.style.opacity !== '0') {
                        logError("React 啟動超時。可能原因：Babel 編譯失敗或瀏覽器阻擋腳本。");
                    }
                }, 5000);
            }
        };
    </script>

    <!-- 3. 主程式 (React) -->
    <script type="text/babel">
        try {
            const { useState, useEffect, useRef } = React;

            // 隱藏載入畫面的函式
            const hideLoader = () => {
                const loader = document.getElementById('loading-screen');
                if(loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.remove(), 500);
                }
            };

            // --- API 邏輯 (Fetch) ---
            const callGeminiApi = async (apiKey, prompt) => {
                if (!apiKey) throw new Error("請先設定 API Key");
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return JSON.parse(text);
            };

            // --- 元件 ---
            const Icon = ({ d, size=18 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d={d} /></svg>
            );
            
            const Icons = {
                Sparkles: () => <Icon d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z M5 3v4 M9 9v4 M3 5h4 M9 3v2" />,
                Volume: () => <Icon d="M11 5 6 9 2 9 2 15 6 15 11 19 11 5 M15.54 8.46a5 5 0 0 1 0 7.07 M19.07 4.93a10 10 0 0 1 0 14.14" />,
                Trash: () => <Icon d="M3 6h18 M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6 M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2 M10 11v6 M14 11v6" />,
                Search: () => <Icon d="circle cx='11' cy='11' r='8' M21 21-4.3-4.3" />,
                Close: () => <Icon d="M18 6 6 18 m6 6 12 12" />
            };

            const AudioBtn = ({ text }) => {
                const [p, setP] = useState(false);
                const play = (e) => {
                    e.stopPropagation();
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'zh-HK'; u.rate = 0.9;
                    u.onstart = () => setP(true);
                    u.onend = () => setP(false);
                    window.speechSynthesis.speak(u);
                };
                return <button onClick={play} className={`p-1.5 rounded-full ${p?'bg-teal-100 text-teal-600':'text-slate-300 hover:text-teal-500'}`}><Icons.Volume/></button>;
            };

            const App = () => {
                const [view, setView] = useState('TRANSLATE');
                const [input, setInput] = useState('');
                const [loading, setLoading] = useState(false);
                const [results, setResults] = useState(null);
                const [history, setHistory] = useState([]);
                const [apiKey, setApiKey] = useState(localStorage.getItem('cantolearn_api_key') || '');
                const [modal, setModal] = useState(null);

                useEffect(() => {
                    hideLoader(); // React 成功啟動，隱藏載入畫面
                    const h = localStorage.getItem('cantolearn_history_v2');
                    if(h) setHistory(JSON.parse(h));
                }, []);

                const doTranslate = async () => {
                    if(!input) return;
                    setLoading(true);
                    try {
                        const res = await callGeminiApi(apiKey, `Translate "${input}" to Cantonese/Traditional Chinese. Output JSON array: [{"text":"詞","jyutping":"ping1","partOfSpeech":"n"}]`);
                        const items = res.items || res; 
                        setResults(items);
                        const newH = [{id:Date.now(), text:input, results:items, date:new Date()}, ...history].slice(0,50);
                        setHistory(newH);
                        localStorage.setItem('cantolearn_history_v2', JSON.stringify(newH));
                    } catch(e) {
                        alert("翻譯錯誤: " + e.message);
                    }
                    setLoading(false);
                };

                const doSuggest = async (word) => {
                    setModal({loading:true, word});
                    try {
                        const res = await callGeminiApi(apiKey, `Hong Kong colloquial for "${word}". Output JSON array: [{"text":"講法","jyutping":"ping1","explanation":"意思"}]`);
                        setModal({loading:false, word, items: res.suggestions || res});
                    } catch(e) {
                        setModal(null);
                    }
                };

                // API Key Modal
                if (!apiKey) return (
                    <div className="fixed inset-0 flex items-center justify-center bg-slate-900/80 p-4 fade-in z-50">
                        <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                            <h2 className="text-xl font-bold text-teal-600 mb-4">輸入 API Key</h2>
                            <input type="password" placeholder="Paste AIza..." className="w-full p-3 border rounded mb-4" onBlur={e => setApiKey(e.target.value)} />
                            <div className="text-xs text-slate-400 mb-4">Key 僅儲存於瀏覽器。</div>
                            <button onClick={() => localStorage.setItem('cantolearn_api_key', apiKey)} disabled={!apiKey} className="w-full bg-teal-600 text-white py-2 rounded font-bold">開始</button>
                            <div className="mt-2 text-center"><a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-xs text-teal-500 underline">取得 Key</a></div>
                        </div>
                    </div>
                );

                return (
                    <div className="min-h-screen flex flex-col pb-10">
                        <header className="bg-white border-b h-16 sticky top-0 z-10 px-4 flex justify-between items-center">
                            <div className="font-bold text-slate-800 flex gap-2 items-center"><span className="bg-teal-600 text-white px-2 rounded">粵</span> CantoLearn AI</div>
                            <div className="flex bg-slate-100 rounded p-1">
                                <button onClick={()=>setView('TRANSLATE')} className={`px-3 py-1 text-xs font-bold rounded ${view==='TRANSLATE'?'bg-white shadow text-teal-700':'text-slate-500'}`}>翻譯</button>
                                <button onClick={()=>setView('HISTORY')} className={`px-3 py-1 text-xs font-bold rounded ${view==='HISTORY'?'bg-white shadow text-teal-700':'text-slate-500'}`}>歷史</button>
                            </div>
                        </header>
                        
                        <main className="max-w-3xl mx-auto w-full p-4">
                            {view === 'TRANSLATE' ? (
                                <div className="space-y-6">
                                    <div className="bg-white p-2 rounded-xl border shadow-sm">
                                        <textarea value={input} onChange={e=>setInput(e.target.value)} placeholder="輸入中文..." className="w-full h-32 p-4 outline-none resize-none text-lg font-chinese"></textarea>
                                        <div className="flex justify-end px-2 pb-2">
                                            <button onClick={doTranslate} disabled={loading||!input} className="bg-teal-600 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 disabled:opacity-50">
                                                {loading ? '...' : <><Icons.Sparkles/> 翻譯</>}
                                            </button>
                                        </div>
                                    </div>
                                    {results && <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        {results.map((r,i)=>(
                                            <div key={i} onClick={()=>doSuggest(r.text)} className="bg-white p-4 rounded-xl border hover:shadow-md cursor-pointer relative group text-center">
                                                <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100"><AudioBtn text={r.text}/></div>
                                                <div className="text-xs font-bold text-slate-300 uppercase">{r.partOfSpeech}</div>
                                                <div className="text-2xl font-bold text-slate-800 mb-1">{r.text}</div>
                                                <div className="text-sm text-teal-600 font-mono bg-teal-50 inline-block px-2 rounded">{r.jyutping}</div>
                                            </div>
                                        ))}
                                    </div>}
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {history.map(h=>(
                                        <div key={h.id} className="bg-white p-4 rounded-xl border shadow-sm">
                                            <div className="flex justify-between mb-2 text-xs text-slate-400">
                                                <span>{new Date(h.date).toLocaleString()}</span>
                                                <button onClick={()=>{const n=history.filter(x=>x.id!==h.id);setHistory(n);localStorage.setItem('cantolearn_history_v2',JSON.stringify(n))}}><Icons.Trash/></button>
                                            </div>
                                            <div className="font-bold text-lg mb-1">{h.text}</div>
                                            <div className="flex gap-2 flex-wrap">{h.results.map((r,i)=><span key={i} className="text-xs bg-slate-50 px-2 border rounded text-slate-600">{r.text} {r.jyutping}</span>)}</div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </main>

                        {modal && (
                            <div className="fixed inset-0 bg-slate-900/40 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
                                <div className="bg-white w-full max-w-sm rounded-2xl p-5 relative">
                                    <button onClick={()=>setModal(null)} className="absolute top-3 right-3 text-slate-400"><Icons.Close/></button>
                                    <h3 className="font-bold mb-4">道地說法: {modal.word}</h3>
                                    {modal.loading ? <div className="text-center text-teal-600">載入中...</div> : 
                                        <div className="space-y-2">
                                            {modal.items?.length ? modal.items.map((s,i)=>(
                                                <div key={i} className="flex justify-between bg-slate-50 p-3 rounded border items-center">
                                                    <div><div className="font-bold">{s.text} <span className="text-teal-600 text-xs">{s.jyutping}</span></div><div className="text-xs text-slate-500">{s.explanation}</div></div>
                                                    <AudioBtn text={s.text}/>
                                                </div>
                                            )) : <div className="text-center text-slate-400 text-sm">無相關建議</div>}
                                        </div>
                                    }
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);

        } catch (err) {
            console.error(err);
            document.getElementById('status-text').innerText = "React Error: " + err.message;
            document.getElementById('loading-screen').style.background = '#fee2e2';
        }
    </script>
</body>
</html>
